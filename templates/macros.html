{% import "bootstrap/wtf.html" as wtf %}

{% macro rmd(text) -%}
{% markdown %}
{{ text }}
{% endmarkdown %}
{%- endmacro %}

{% macro render_info_block(title, id) -%}
<div class="panel panel-info">
    <div class="panel-heading">
        <strong class="panel-title">
            <a role="button" data-toggle="collapse" href="#{{ id }}">
                {{ title }}
            </a>
        </strong>
    </div>
    <div class="panel-body collapse" id="{{ id }}">
        {% set content=caller() %}
        {% markdown %}
        {{ content }}
        {% endmarkdown %}
    </div>
</div>
{%- endmacro %}

{% macro question_block() -%}
<div class="question">
        {{ caller() }}
</div>
{%- endmacro %}

{% macro question_container_block(field_name=None) -%}
<div class="question-container"
    {% if field_name %}
        id="q-{{ field_name }}"
        data-question="{{ field_name }}"
    {% endif %}
>
        {{ caller() }}
</div>
{%- endmacro %}

{% macro evidence_block(field, field_id, title="Evidence", button_label="Evidence") -%}
<div class="evidence-block">
    {% if mode == "edit" %}
    <button type="button"
        class="btn btn-primary btn-sm js-evidence-open"
        data-evidence-field="{{ field_id }}"
        data-evidence-title="{{ title }}"
    >
        {{ button_label }}
    </button>
    {% else %}
    <button type="button"
        class="btn btn-info btn-sm js-evidence-open"
        data-evidence-field="{{ field_id }}"
        data-evidence-title="{{ title }}"
    >
        View
    </button>
    {% endif %}

    <div class="evidence-preview" id="{{ field_id }}-preview">
        {% set preview_text=(field.data or "") | striptags | trim %}
        {% if preview_text %}
            {{ preview_text | truncate(140) }}
        {% else %}
            <span class="text-muted"><em>No evidence yet.</em></span>
        {% endif %}
    </div>

    {{ field(id=field_id, class="evidence-storage", style="display:none") }}
</div>
{%- endmacro %}

{% macro question_full_block(form_field, form_field_e, form_field_e_id) -%}
                {% set evidence_title = (form_field.name | header) | replace('#', '') | replace('*', '') | trim %}
                {% call question_container_block(form_field.name) %}
                {% call question_block() %}
                {{ wtf.form_field(form_field) }}
                <div class="validation-msg" data-for="{{ form_field.name }}"></div>
                {% endcall %}
                {{ evidence_block(form_field_e, form_field_e_id, evidence_title, "Evidence") }}
                {% endcall %}
{%- endmacro %}
